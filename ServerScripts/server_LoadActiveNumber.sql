use rcbill_my;


-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-01052016-31082016.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-01092016-30092016.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-01102016-31102016.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-01112016-30112016.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-01122016-31122016.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-01012017-22012017.csv' 
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-23012017.csv' 
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-24012017.csv' 
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-25012017.csv' 
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-26012017.csv' 
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-27012017.csv' 
-- LOAD DATA LOW_PRIORITY LOCAL INFILE  'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-28012017-29012017.csv' 
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-30012017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-31012017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-01022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-02022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-03022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-04022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-05022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-06022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-07022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-08022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-09022017-10022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-11022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-12022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-13022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-14022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-15022017-16022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-17022017-19022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-20022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-21022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-22022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-23022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-24022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-25022017-26022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-27022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-28022017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-01032017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-02032017.csv'
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-03032017.csv'
SET @rundate='2017-12-26';
-- LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-24122017-25122017.csv'

 LOAD DATA LOW_PRIORITY LOCAL INFILE 'C:/ProgramData/MySQL/MySQL Server 5.7/Uploads/activenumber/DailySubscriptionStats-26122017.csv'

INTO TABLE rcbill_my.activenumber 
FIELDS TERMINATED BY ',' LINES TERMINATED BY '\r\n' 
IGNORE 1 LINES 
(
@periodorig,
@baseservice,
@service,
@servicetypeold,
@clientclassold,
@regionallevel3,
@regionallevel2,
@regionallevel1,
@regionold,
@distributor,
@promotion,
@validity,
@open,
@new,
@newconverted,
@renew,
@closed,
@closednonpayment,
@suspended,
@closedconverted,
@closedother,
@disconnected,
@disconnectedtotal,
@disconnectedall,
@connected,
@connectedtotal,
@pendingorders
) 
set 
activenumberid=null,
periodorig = @periodorig,
period = (select substring_index(@periodorig,';',1)),
periodday = (select extract(day from period)),
periodmth = (select extract(month from period)),
periodyear = (select extract(year from period)),
weekday=(select dayname(period)),
mthname=(select monthname(period)),
baseservice = @baseservice,
service = @service,
servicecategory = (select servicecategory from rcbill_my.lkpbaseservice where service=@service),
servicesubcategory = (select servicesubcategory from rcbill_my.lkpbaseservice where service=@service),

servicetypeold = @servicetypeold,
servicetypeold1 = (select servicenewtype from rcbill_my.lkpservicetype where servicetype=@servicetypeold),
servicetype = (select GetServiceType(servicetypeold,servicetypeold1,service)),

clientclassold = @clientclassold,
clientclass = (select NewClientClass from rcbill_my.lkpclienttype where origclientclass=@clientclassold),
clienttype = (select clienttype from rcbill_my.lkpclienttype where origclientclass=@clientclassold),

regionallevel1 = @regionallevel1,
regionallevel2 = @regionallevel2,
regionallevel3 = @regionallevel3,
regionold = @regionold,
region = (select newregion from rcbill_my.lkpregion where origregion=@regionold),

distributor = @distributor,
promotion = @promotion,
validity = @validity,

open = @open,
new = @new,
newconverted = @newconverted,
renew = @renew,
closed = @closed,
closednonpayment = @closednonpayment,
suspended = @suspended,
closedconverted = @closedconverted,
closedother = @closedother,
disconnected = @disconnected,
disconnectedtotal = @disconnectedtotal,
disconnectedall = @disconnectedall,
connected = @connected,
connectedtotal = @connectedtotal,
pendingorders = @pendingorders,

totalopened = (new+newconverted+renew),
totalclosed = (closed+suspended+closednonpayment+closedconverted+closedother),
difference = (totalopened - totalclosed),
totalcheck = (open+new+newconverted+renew+closed+closednonpayment+suspended+closedconverted+closedother+disconnected+disconnectedtotal+disconnectedall+connected+connectedtotal),
decommissioned = (select IsDecom(totalcheck)),
reported = (select reported from rcbill_my.lkpreported where servicenewtype=servicetype)
;


drop table if exists rcbill_my.packagelist;

create table rcbill_my.packagelist as
(
select distinct servicecategory, GetServiceCategory2(service) as servicecategory2, service, getcleanstring(servicetypeold) as package, servicetype,  servicesubcategory, rcbill.GetServicePrice(service,getcleanstring(servicetypeold)) as packageprice
from rcbill_my.activenumber
where reported='Y' and decommissioned='N'
and period=@rundate
group by 
servicecategory, GetServiceCategory2(servicecategory), service, package, servicetype,  servicesubcategory
order by 
servicecategory
);

select servicecategory, servicecategory2, service, package, servicetype, servicesubcategory, packageprice from rcbill_my.packagelist;

select * from rcbill_my.activenumber where period=@rundate and reported='Y' and decommissioned='N';

-- select distinct servicecategory from rcbill_my.packagelist;
-- select distinct servicecategory2 from rcbill_my.packagelist where servicecategory in (select distinct servicecategory from rcbill_my.packagelist);
 
-- delete from rcbill_my.activenumber where period in ('2017-06-22');